// 【全文出力】精度向上版ロジック
const video = document.getElementById('video');
const status = document.getElementById('status');
const btn = document.getElementById('btn');
const voteTo = document.getElementById('voteTo');
const API_URL = "https://kofusai-api.あなたの名前.workers.dev"; // 自分のURLに！

async function init() {
    try {
        const MODEL_URL = 'https://justadudewhohacks.github.io/face-api.js/models/';
        await Promise.all([
            faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
            faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
            faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
        ]);
        const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
        video.srcObject = stream;
        status.innerText = "準備完了！";
        btn.disabled = false;
    } catch (e) {
        status.innerText = "エラー: " + e.message;
    }
}

// 複数の特徴量の平均を計算する関数
function getAverageDescriptor(descriptors) {
    const size = descriptors[0].length;
    const avg = new Float32Array(size);
    for (let i = 0; i < size; i++) {
        let sum = 0;
        for (let j = 0; j < descriptors.length; j++) {
            sum += descriptors[j][i];
        }
        avg[i] = sum / descriptors.length;
    }
    return Array.from(avg);
}

btn.onclick = async () => {
    btn.disabled = true;
    const samples = [];
    const maxSamples = 5; // 5回スキャンして平均を取る

    for (let i = 0; i < maxSamples; i++) {
        status.innerText = `スキャン中... (${i + 1}/${maxSamples})`;
        
        const result = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions())
                                    .withFaceLandmarks()
                                    .withFaceDescriptor();

        if (!result) {
            status.innerText = "顔を見失いました。正面を向いてください。";
            btn.disabled = false;
            return;
        }

        // --- 対策(2): 距離チェック ---
        const faceBox = result.detection.box;
        const faceRatio = faceBox.width / video.videoWidth;
        if (faceRatio < 0.3) { // 顔が画面横幅の30%未満なら遠すぎ
            status.innerText = "遠すぎます！もっとカメラに近づいてください。";
            btn.disabled = false;
            return;
        }
        if (faceRatio > 0.7) { // 逆に近すぎても歪むのでガード
            status.innerText = "近すぎます！少し離れてください。";
            btn.disabled = false;
            return;
        }

        samples.push(result.descriptor);
        await new Promise(r => setTimeout(r, 100)); // 少し待機して次のスキャンへ
    }

    // --- 対策(3): 平均化 ---
    const avgDescriptor = getAverageDescriptor(samples);
    status.innerText = "データを照合中...";

    try {
        const response = await fetch(API_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                descriptor: avgDescriptor,
                voteTo: voteTo.value
            })
        });

        const data = await response.json();
        if (response.ok) {
            status.innerText = "✅ " + data.message;
            status.style.color = "#34C759";
        } else {
            status.innerText = "❌ " + data.message;
            status.style.color = "#FF3B30";
            btn.disabled = false;
        }
    } catch (e) {
        status.innerText = "通信エラー";
        btn.disabled = false;
    }
};

init();
