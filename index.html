<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>興風祭 顔認証投票システム</title>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <style>
        :root { --primary: #34C759; --bg: #000; --card: #1c1c1e; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: #fff; margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .container { background: var(--card); padding: 2rem; border-radius: 24px; width: 90%; max-width: 400px; text-align: center; border: 1px solid #333; }
        #video-container { position: relative; width: 100%; height: 300px; background: #333; border-radius: 16px; overflow: hidden; margin-bottom: 1rem; }
        video, canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
        select, button { width: 100%; padding: 12px; margin-top: 10px; border-radius: 10px; border: none; font-size: 1rem; font-weight: bold; }
        select { background: #2c2c2e; color: #fff; border: 1px solid #444; }
        button { background: var(--primary); color: white; cursor: pointer; transition: 0.2s; }
        button:disabled { background: #444; cursor: not-allowed; }
        #status { margin: 15px 0; font-size: 0.9rem; color: #aaa; }
    </style>
</head>
<body>

<div class="container">
    <h2>興風祭 投票</h2>
    <div id="status">AIモデルを読み込み中...</div>

    <div id="video-container">
        <video id="video" autoplay muted playsinline></video>
        <canvas id="overlay"></canvas>
    </div>

    <label for="voteTo">投票先を選択：</label>
    <select id="voteTo">
        <option value="物理研究部">物理研究部</option>
        <option value="化学部">化学部</option>
        <option value="生物部">生物部</option>
        <option value="レゴプログラミング班">レゴプログラミング班</option>
    </select>

    <button id="btn" disabled>スキャンして投票</button>
</div>

<script>
    // 【重要】自分のWorkerのURLに書き換えてください
    const API_URL = "https://kofusai-api.nengjianxingtai44.workers.dev";

    const video = document.getElementById('video');
    const status = document.getElementById('status');
    const btn = document.getElementById('btn');
    const voteTo = document.getElementById('voteTo');

    // 1. AIモデルとカメラの起動
    async function init() {
        try {
            const MODEL_URL = 'https://justadudewhohacks.github.io/face-api.js/models/';
            await Promise.all([
                faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
            ]);

            const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
            video.srcObject = stream;
            status.innerText = "準備完了！正面を向いてください";
            btn.disabled = false;
        } catch (e) {
            status.innerText = "エラー: " + e.message;
        }
    }

    // 2. 投票ボタンが押された時の処理
    btn.onclick = async () => {
        btn.disabled = true;
        status.innerText = "顔情報を解析中...";

        // 顔をスキャン
        const result = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions())
                                    .withFaceLandmarks()
                                    .withFaceDescriptor();

        if (!result) {
            status.innerText = "顔が見つかりません。";
            btn.disabled = false;
            return;
        }

        // Workerへ送信
        try {
            const response = await fetch(API_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    descriptor: Array.from(result.descriptor),
                    voteTo: voteTo.value
                })
            });

            const data = await response.json();

            if (response.ok) {
                status.innerText = "✅ " + data.message;
                status.style.color = "#34C759";
                btn.innerText = "投票完了";
            } else {
                status.innerText = "❌ " + data.message;
                status.style.color = "#FF3B30";
                btn.disabled = false;
            }
        } catch (e) {
            status.innerText = "通信エラーが発生しました。";
            btn.disabled = false;
        }
    };

    init();
</script>
</body>
</html>
